{% extends "base.html" %}

{% block title %}Djanswer - Room #{{ roomCode }}{% endblock %}

{% block content %}
    {% load bootstrap_icons %}
    <br>
    <div class="d-flex justify-content-center mb-3 game-phase">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
    </div>
    <div class="row justify-content-center mb-3 game-phase d-none" id="questionsPhase">
        <div class="col-md-6 card">
            <div class="card-body">
                <div class="card-title">
                    <p class="h2">Write your question below!</p>
                    <p class="h4 text-muted fs-6">Remember, you'll receive points if the most voted answer is for your question.</p>
                </div>
                <input type="text" class="form-control" placeholder="What did you eat last night?">
                <button class="btn btn-primary w-100 mt-2">submit <span id="questionsTimer" class="fs-6"></span></button>
                </div>
            </div>
        </div>
    </div>



    <script>
        const roomCode = '{{ room.code }}';
        const currentUser = '{{ user.username }}';

        {// socket functions        
            const chatSocket = new WebSocket(
                'ws://'
                + window.location.host
                + '/ws/room/'
                + roomCode
                + '/game'
            );

            chatSocket.onopen = function () {
                chatSocket.send(JSON.stringify({
                    'type': 'connected'
                }));
            }

            chatSocket.onmessage = function(e) {
                const message = JSON.parse(e.data);
                if (message.type === 'question_phase_started') {
                    document.querySelector('.game-phase').classList.add('d-none');
                    document.querySelector('#questionsPhase').classList.remove('d-none');
                    questionsRemainingSeconds = message.remaining_time;
                    timer(message.remaining_time, document.querySelector('#questionsTimer'))
                }
            };

            chatSocket.onclose = function(e) {
                console.error('Chat socket closed unexpectedly');
            };
        }

        {// Timers
            function timer(remainingSeconds, targetElement) {
                remainingSeconds = remainingSeconds > 0 ? remainingSeconds : 0;
                targetElement.innerText = '(' + remainingSeconds + ')';

                if (remainingSeconds <= 0) {
                    return;
                }

                setTimeout(timer, 1000, remainingSeconds - 1, targetElement);
            }
        }
    </script>
{% endblock %}